<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ProCamSolver: MeasurementMatrix.hpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>MeasurementMatrix.hpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="comment">//</span>
<a name="l00003"></a>00003 <span class="comment">// Copyright (c) 2012 Daniel Tang.</span>
<a name="l00004"></a>00004 <span class="comment">//</span>
<a name="l00005"></a>00005 <span class="comment">//  Licensed under the Apache License, Version 2.0 (the "License");</span>
<a name="l00006"></a>00006 <span class="comment">//  you may not use this file except in compliance with the License.</span>
<a name="l00007"></a>00007 <span class="comment">//  You may obtain a copy of the License at</span>
<a name="l00008"></a>00008 <span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment">//       http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00010"></a>00010 <span class="comment">//</span>
<a name="l00011"></a>00011 <span class="comment">//   Unless required by applicable law or agreed to in writing,</span>
<a name="l00012"></a>00012 <span class="comment">//   software distributed under the License is distributed on an "AS</span>
<a name="l00013"></a>00013 <span class="comment">//   IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either</span>
<a name="l00014"></a>00014 <span class="comment">//   express or implied.  See the License for the specific language</span>
<a name="l00015"></a>00015 <span class="comment">//   governing permissions and limitations under the License.</span>
<a name="l00016"></a>00016 <span class="comment">//</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 
<a name="l00030"></a>00030 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00031"></a><a class="code" href="classMeasurementMatrix.html#01e119caefd759f2b9a2e65ce7c2dcc6">00031</a> <span class="keywordtype">bool</span> <a class="code" href="classMeasurementMatrix.html#01e119caefd759f2b9a2e65ce7c2dcc6">MeasurementMatrix&lt;M&gt;::load</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename) {
<a name="l00032"></a>00032   std::ifstream myFile(filename);
<a name="l00033"></a>00033   <span class="keywordtype">int</span> i;
<a name="l00034"></a>00034   <a class="code" href="classCorrespondence.html">Correspondence</a> c;
<a name="l00035"></a>00035 
<a name="l00036"></a>00036   <span class="keywordflow">if</span>(!myFile) <span class="keywordflow">return</span>(<span class="keyword">false</span>);
<a name="l00037"></a>00037   i = 10000;
<a name="l00038"></a>00038   <span class="keywordflow">while</span>(i &gt;0 &amp;&amp; (myFile &gt;&gt; c)) {
<a name="l00039"></a>00039     <a class="code" href="classMeasurementMatrix.html#358011dcd5519fa9fc39a56f9386e964">add_correspondence</a>(c);
<a name="l00040"></a>00040     <span class="comment">//    std::cout &lt;&lt; c &lt;&lt; std::endl;</span>
<a name="l00041"></a>00041     --i;
<a name="l00042"></a>00042   }
<a name="l00043"></a>00043   myFile.close();
<a name="l00044"></a>00044   <span class="keywordflow">return</span>(<span class="keyword">true</span>);
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 
<a name="l00061"></a>00061 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00062"></a><a class="code" href="classMeasurementMatrix.html#9823bc472bb1e95a7019af8d2c2782a7">00062</a> <span class="keywordtype">void</span> <a class="code" href="classMeasurementMatrix.html#9823bc472bb1e95a7019af8d2c2782a7">MeasurementMatrix&lt;M&gt;::normalise</a>(<a class="code" href="classImageTransform.html">ImageTransform&lt;M&gt;</a> &amp;denormalisation,
<a name="l00063"></a>00063                                      <span class="keywordtype">bool</span> fixedAspect) {
<a name="l00064"></a>00064   Eigen::Vector3d mean;
<a name="l00065"></a>00065   Eigen::Vector2d sd;
<a name="l00066"></a>00066   Eigen::Matrix3d K;
<a name="l00067"></a>00067   <span class="keywordtype">int</span> v;
<a name="l00068"></a>00068   <span class="keywordtype">int</span> point;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070   <a class="code" href="classMeasurementMatrix.html#50bb8f66a31065040fd1be6964fbfe5e">unscale</a>();
<a name="l00071"></a>00071   K.setZero();
<a name="l00072"></a>00072   <span class="keywordflow">for</span>(v = 0; v &lt; M; ++v) {
<a name="l00073"></a>00073     mean = <a class="code" href="classMeasurementMatrix.html#dadbcfb5d897ec52ed11d5c5eda59855">view</a>(v).rowwise().sum();
<a name="l00074"></a>00074     sd   = <a class="code" href="classMeasurementMatrix.html#dadbcfb5d897ec52ed11d5c5eda59855">view</a>(v).topRows(2).rowwise().squaredNorm();
<a name="l00075"></a>00075     <span class="keywordflow">if</span>(mean(2) == 0.0) mean(2) = 1.0; <span class="comment">// no data for view</span>
<a name="l00076"></a>00076     sd   /= mean(2);
<a name="l00077"></a>00077     mean /= mean(2);
<a name="l00078"></a>00078     sd = (sd - mean.cwiseProduct(mean).topRows(2));
<a name="l00079"></a>00079     <span class="keywordflow">if</span>(fixedAspect) {
<a name="l00080"></a>00080       sd(0) = sd(1) = (sd(0) + sd(1))*0.5;
<a name="l00081"></a>00081     }
<a name="l00082"></a>00082     sd = sd.cwiseSqrt();
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <span class="keywordflow">if</span>(sd(0) == 0.0) sd(0) = 1.0;
<a name="l00085"></a>00085     <span class="keywordflow">if</span>(sd(1) == 0.0) sd(1) = 1.0;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087     K(0,0) = 1.0/sd(0);
<a name="l00088"></a>00088     K(1,1) = 1.0/sd(1);
<a name="l00089"></a>00089     K(0,2) = -mean(0)/sd(0);
<a name="l00090"></a>00090     K(1,2) = -mean(1)/sd(1);
<a name="l00091"></a>00091     K(2,2) = 1.0;    
<a name="l00092"></a>00092     <a class="code" href="classMeasurementMatrix.html#dadbcfb5d897ec52ed11d5c5eda59855">view</a>(v) = K*<a class="code" href="classMeasurementMatrix.html#dadbcfb5d897ec52ed11d5c5eda59855">view</a>(v);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     <span class="comment">// --- form inverse</span>
<a name="l00095"></a>00095     K(0,0) = sd(0);
<a name="l00096"></a>00096     K(1,1) = sd(1);
<a name="l00097"></a>00097     K(0,2) = mean(0);
<a name="l00098"></a>00098     K(1,2) = mean(1);
<a name="l00099"></a>00099     denormalisation.<a class="code" href="classImageTransform.html#036550c9eda1b7df8c9aca3adc45a938">view</a>(v) = K;
<a name="l00100"></a>00100   }
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 
<a name="l00109"></a>00109 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00110"></a><a class="code" href="classMeasurementMatrix.html#17df03814e515221ffafb893c47e70e7">00110</a> <span class="keywordtype">void</span> <a class="code" href="classMeasurementMatrix.html#17df03814e515221ffafb893c47e70e7">MeasurementMatrix&lt;M&gt;::scale_and_fill</a>(<span class="keyword">const</span> <a class="code" href="classMotionMatrix.html">MotionMatrix&lt;M&gt;</a> &amp;P, 
<a name="l00111"></a>00111                                           <span class="keyword">const</span> <a class="code" href="classShapeMatrix.html">ShapeMatrix</a> &amp;X) {
<a name="l00112"></a>00112   <span class="keywordtype">int</span> i,j;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   <span class="keywordflow">for</span>(j = 0; j&lt;cols(); ++j) {
<a name="l00115"></a>00115     <span class="keywordflow">for</span>(i = 0; i&lt;M; ++i) {
<a name="l00116"></a>00116       <span class="keywordflow">if</span>(<a class="code" href="classMeasurementMatrix.html#a5f1f98d7fc2d7862be7c2309fafb7b2">pixel_is_occluded</a>(i,j)) {
<a name="l00117"></a>00117         <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j) = P.<a class="code" href="classMotionMatrix.html#e6f06dec59a8f1bd8c511413b1ad5f02">view</a>(i) * X.col(j);
<a name="l00118"></a>00118       } <span class="keywordflow">else</span> {
<a name="l00119"></a>00119         <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j) *= (P.<a class="code" href="classMotionMatrix.html#e6f06dec59a8f1bd8c511413b1ad5f02">view</a>(i).row(2) * X.col(j))/<a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j)(2);
<a name="l00120"></a>00120       }
<a name="l00121"></a>00121     }
<a name="l00122"></a>00122   }
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 
<a name="l00131"></a>00131 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00132"></a><a class="code" href="classMeasurementMatrix.html#358011dcd5519fa9fc39a56f9386e964">00132</a> <span class="keywordtype">int</span> <a class="code" href="classMeasurementMatrix.html#358011dcd5519fa9fc39a56f9386e964">MeasurementMatrix&lt;M&gt;::add_correspondence</a>(<span class="keyword">const</span> <a class="code" href="classCorrespondence.html">Correspondence</a> &amp;corr) {
<a name="l00133"></a>00133   <span class="keywordtype">int</span> icolumn = <a class="code" href="classMeasurementMatrix.html#fd158fb3e361a3437aa4f04d36bc2fc2">column_containing</a>(corr.<a class="code" href="classCorrespondence.html#fac2d2051823b87bdc8d1de09311dd4e">i</a>);
<a name="l00134"></a>00134   <span class="keywordtype">int</span> jcolumn = <a class="code" href="classMeasurementMatrix.html#fd158fb3e361a3437aa4f04d36bc2fc2">column_containing</a>(corr.<a class="code" href="classCorrespondence.html#bbf3fd79d7a2777a634a225dff2140b1">j</a>);
<a name="l00135"></a>00135 
<a name="l00136"></a>00136   <span class="keywordflow">if</span>(icolumn &lt; 0) {
<a name="l00137"></a>00137     <span class="keywordflow">if</span>(jcolumn &lt; 0) {                    <span class="comment">// neither exist yet</span>
<a name="l00138"></a>00138       icolumn = <a class="code" href="classMeasurementMatrix.html#a93cbb8a0ae1936a512a9fd93ed149af">new_column</a>();
<a name="l00139"></a>00139       <a class="code" href="classMeasurementMatrix.html#c66ccaf22bcef4e339ffe9d6c98a103b">insert_pixel</a>(icolumn, corr.<a class="code" href="classCorrespondence.html#fac2d2051823b87bdc8d1de09311dd4e">i</a>);
<a name="l00140"></a>00140       <a class="code" href="classMeasurementMatrix.html#c66ccaf22bcef4e339ffe9d6c98a103b">insert_pixel</a>(icolumn, corr.<a class="code" href="classCorrespondence.html#bbf3fd79d7a2777a634a225dff2140b1">j</a>);      
<a name="l00141"></a>00141     } <span class="keywordflow">else</span> {                            <span class="comment">// j exists, i doesn't</span>
<a name="l00142"></a>00142       <a class="code" href="classMeasurementMatrix.html#c66ccaf22bcef4e339ffe9d6c98a103b">insert_pixel</a>(jcolumn, corr.<a class="code" href="classCorrespondence.html#fac2d2051823b87bdc8d1de09311dd4e">i</a>);
<a name="l00143"></a>00143       <span class="keywordflow">return</span>(jcolumn);
<a name="l00144"></a>00144     }
<a name="l00145"></a>00145   } <span class="keywordflow">else</span> {
<a name="l00146"></a>00146     <span class="keywordflow">if</span>(jcolumn &lt; 0) {                    <span class="comment">// i exists, j doesn't</span>
<a name="l00147"></a>00147       <a class="code" href="classMeasurementMatrix.html#c66ccaf22bcef4e339ffe9d6c98a103b">insert_pixel</a>(icolumn, corr.<a class="code" href="classCorrespondence.html#bbf3fd79d7a2777a634a225dff2140b1">j</a>);
<a name="l00148"></a>00148     } <span class="keywordflow">else</span> {                            <span class="comment">// both exist</span>
<a name="l00149"></a>00149       <a class="code" href="classMeasurementMatrix.html#e6dc25c2b3aa8eeab7b19dfc36d87051">merge_columns</a>(icolumn, jcolumn);
<a name="l00150"></a>00150     }
<a name="l00151"></a>00151   }
<a name="l00152"></a>00152   <span class="keywordflow">return</span>(icolumn);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 
<a name="l00164"></a>00164 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00165"></a><a class="code" href="classMeasurementMatrix.html#fd158fb3e361a3437aa4f04d36bc2fc2">00165</a> <span class="keywordtype">int</span> <a class="code" href="classMeasurementMatrix.html#fd158fb3e361a3437aa4f04d36bc2fc2">MeasurementMatrix&lt;M&gt;::column_containing</a>(<span class="keyword">const</span> <a class="code" href="classGPixel.html">GPixel</a> &amp;G) {
<a name="l00166"></a>00166   <span class="keywordtype">int</span> j;
<a name="l00167"></a>00167   <span class="keywordflow">for</span>(j = 0; j&lt;cols(); ++j) {
<a name="l00168"></a>00168     <span class="keywordflow">if</span>(fabs(<a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(G.<a class="code" href="classGPixel.html#5838e0e085f8bc6267d57e83732fa10e">id</a>, j)(0) - G.<a class="code" href="classGPixel.html#7bd069cdb4aa390e7de6fbdd35fd6181">x</a>) &lt; 1e-5 &amp;&amp;
<a name="l00169"></a>00169        fabs(<a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(G.<a class="code" href="classGPixel.html#5838e0e085f8bc6267d57e83732fa10e">id</a>, j)(1) - G.<a class="code" href="classGPixel.html#fbcc5faf9aed7beb2427625d244b1cf6">y</a>) &lt; 1e-5) {
<a name="l00170"></a>00170       <span class="keywordflow">return</span>(j);
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172   }
<a name="l00173"></a>00173   <span class="keywordflow">return</span>(-1);
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 
<a name="l00183"></a>00183 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00184"></a><a class="code" href="classMeasurementMatrix.html#dadbcfb5d897ec52ed11d5c5eda59855">00184</a> <span class="keyword">typename</span> <a class="code" href="classMeasurementMatrix.html">MeasurementMatrix&lt;M&gt;::ViewRef</a> <a class="code" href="classMeasurementMatrix.html#dadbcfb5d897ec52ed11d5c5eda59855">MeasurementMatrix&lt;M&gt;::view</a>(<span class="keywordtype">int</span> i) {
<a name="l00185"></a>00185   <span class="keywordflow">return</span>(middleRows(3*i,3));
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 
<a name="l00202"></a>00202 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00203"></a><a class="code" href="classMeasurementMatrix.html#a1d9a47c20c0e2da3d09a1cfa64eddb5">00203</a> <span class="keywordtype">void</span> <a class="code" href="classMeasurementMatrix.html#a1d9a47c20c0e2da3d09a1cfa64eddb5">MeasurementMatrix&lt;M&gt;::synthesise_measurements</a>(<span class="keyword">const</span> <a class="code" href="classMotionMatrix.html">MotionMatrix&lt;M&gt;</a> &amp;P, 
<a name="l00204"></a>00204                                                   <span class="keywordtype">int</span> pts, <span class="keywordtype">double</span> noise) {
<a name="l00205"></a>00205   <a class="code" href="classShapeMatrix.html">ShapeMatrix</a>           X;
<a name="l00206"></a>00206   Eigen::Matrix4d       shift;  
<a name="l00207"></a>00207   Eigen::RowVectorXd    noiseVec;
<a name="l00208"></a>00208   <span class="keywordtype">int</span>                   i;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210   <span class="comment">// --- fill X with homogeneous 3D points centred around origin</span>
<a name="l00211"></a>00211   X.resize(4,pts);
<a name="l00212"></a>00212   X = ShapeMatrix::Random(4,pts);
<a name="l00213"></a>00213   X.row(3).fill(1.0);
<a name="l00214"></a>00214   
<a name="l00215"></a>00215   <span class="comment">// --- shift centre to (0,0,1.5)</span>
<a name="l00216"></a>00216   shift = Eigen::Matrix4d::Identity();
<a name="l00217"></a>00217   shift(2,3) = 1.5;
<a name="l00218"></a>00218   X = shift*X;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220   <span class="comment">// --- form matrix and add noise</span>
<a name="l00221"></a>00221   (*this) = P*X;
<a name="l00222"></a>00222   <a class="code" href="classMeasurementMatrix.html#50bb8f66a31065040fd1be6964fbfe5e">unscale</a>();
<a name="l00223"></a>00223   noiseVec.resize(cols());
<a name="l00224"></a>00224   <span class="keywordflow">for</span>(i = 0; i&lt;M; ++i) {
<a name="l00225"></a>00225     noiseVec = Eigen::RowVectorXd::Random(cols())*noise;
<a name="l00226"></a>00226     row(3*i) += noiseVec;
<a name="l00227"></a>00227     noiseVec = Eigen::RowVectorXd::Random(cols())*noise;
<a name="l00228"></a>00228     row(3*i+1) += noiseVec;
<a name="l00229"></a>00229   }
<a name="l00230"></a>00230 }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 
<a name="l00238"></a>00238 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00239"></a><a class="code" href="classMeasurementMatrix.html#f85e926f3c754f12ef699dc9a0961e47">00239</a> <span class="keywordtype">void</span> <a class="code" href="classMeasurementMatrix.html#f85e926f3c754f12ef699dc9a0961e47">MeasurementMatrix&lt;M&gt;::synthesise_occlusions</a>(<span class="keywordtype">double</span> proportion) {
<a name="l00240"></a>00240   <span class="keywordtype">int</span> i,j;
<a name="l00241"></a>00241   <span class="keywordflow">for</span>(i = 0; i&lt;M; ++i) {
<a name="l00242"></a>00242     <span class="keywordflow">for</span>(j=0; j&lt;cols(); ++j) {
<a name="l00243"></a>00243       <span class="keywordflow">if</span>(rand()*1.0/RAND_MAX &lt;= proportion) {
<a name="l00244"></a>00244         <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j).fill(0.0);
<a name="l00245"></a>00245       }
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247   }
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 
<a name="l00256"></a>00256 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00257"></a><a class="code" href="classMeasurementMatrix.html#50bb8f66a31065040fd1be6964fbfe5e">00257</a> <span class="keywordtype">void</span> <a class="code" href="classMeasurementMatrix.html#50bb8f66a31065040fd1be6964fbfe5e">MeasurementMatrix&lt;M&gt;::unscale</a>() {
<a name="l00258"></a>00258   <span class="keywordtype">int</span> i,j;
<a name="l00259"></a>00259   
<a name="l00260"></a>00260   <span class="keywordflow">for</span>(i = 0; i&lt;M; ++i) {
<a name="l00261"></a>00261     <span class="keywordflow">for</span>(j = 0; j&lt;cols(); ++j) {
<a name="l00262"></a>00262       <span class="keywordflow">if</span>(!<a class="code" href="classMeasurementMatrix.html#a5f1f98d7fc2d7862be7c2309fafb7b2">pixel_is_occluded</a>(i,j)) {
<a name="l00263"></a>00263         <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j)(0) /= <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j)(2);
<a name="l00264"></a>00264         <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j)(1) /= <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j)(2);
<a name="l00265"></a>00265         <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j)(2) = 1.0;
<a name="l00266"></a>00266       }
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268   }
<a name="l00269"></a>00269 }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 
<a name="l00280"></a>00280 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00281"></a>00281 <span class="keyword">typename</span> <a class="code" href="classMeasurementMatrix.html">MeasurementMatrix&lt;M&gt;::PixelRef</a>
<a name="l00282"></a><a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">00282</a> <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">MeasurementMatrix&lt;M&gt;::pixel</a>(<span class="keywordtype">int</span> <a class="code" href="classMeasurementMatrix.html#dadbcfb5d897ec52ed11d5c5eda59855">view</a>, <span class="keywordtype">int</span> point) {
<a name="l00283"></a>00283   <span class="keywordflow">return</span>(Base::template block&lt;3,1&gt;(view*3,point));
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00286"></a>00286 <span class="keyword">typename</span> <a class="code" href="classMeasurementMatrix.html">MeasurementMatrix&lt;M&gt;::constPixelRef</a>
<a name="l00287"></a>00287 <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">MeasurementMatrix&lt;M&gt;::pixel</a>(<span class="keywordtype">int</span> <a class="code" href="classMeasurementMatrix.html#dadbcfb5d897ec52ed11d5c5eda59855">view</a>, <span class="keywordtype">int</span> point)<span class="keyword"> const </span>{
<a name="l00288"></a>00288   <span class="keywordflow">return</span>(Base::template block&lt;3,1&gt;(view*3,point));
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 
<a name="l00296"></a>00296 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00297"></a><a class="code" href="classMeasurementMatrix.html#a5f1f98d7fc2d7862be7c2309fafb7b2">00297</a> <span class="keywordtype">bool</span> <a class="code" href="classMeasurementMatrix.html#a5f1f98d7fc2d7862be7c2309fafb7b2">MeasurementMatrix&lt;M&gt;::pixel_is_occluded</a>(<span class="keywordtype">int</span> view, <span class="keywordtype">int</span> point)<span class="keyword"> const </span>{
<a name="l00298"></a>00298   <span class="keywordtype">double</span> scale = <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(view, point)(2);
<a name="l00299"></a>00299   <span class="keywordflow">return</span>(scale == 0.0);<span class="comment">// &amp;&amp; std::signbit(scale) == 0);</span>
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00302"></a>00302 
<a name="l00309"></a>00309 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00310"></a><a class="code" href="classMeasurementMatrix.html#a93cbb8a0ae1936a512a9fd93ed149af">00310</a> <span class="keywordtype">int</span> <a class="code" href="classMeasurementMatrix.html#a93cbb8a0ae1936a512a9fd93ed149af">MeasurementMatrix&lt;M&gt;::new_column</a>() {
<a name="l00311"></a>00311   conservativeResize(Eigen::NoChange, cols()+1);
<a name="l00312"></a>00312   <span class="keywordflow">return</span>(cols()-1);
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 
<a name="l00321"></a>00321 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00322"></a><a class="code" href="classMeasurementMatrix.html#05d194eb20237c7c874213c74819754b">00322</a> <span class="keywordtype">int</span> <a class="code" href="classMeasurementMatrix.html#05d194eb20237c7c874213c74819754b">MeasurementMatrix&lt;M&gt;::new_columns</a>(<span class="keywordtype">int</span> n) {
<a name="l00323"></a>00323   conservativeResize(Eigen::NoChange, cols()+n);
<a name="l00324"></a>00324   <span class="keywordflow">return</span>(cols()-n);
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 
<a name="l00355"></a>00355 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00356"></a><a class="code" href="classMeasurementMatrix.html#94d0b0016f655ffd1b395db41ebe1a59">00356</a> <span class="keywordtype">int</span> <a class="code" href="classMeasurementMatrix.html#94d0b0016f655ffd1b395db41ebe1a59">MeasurementMatrix&lt;M&gt;::insert_column_and_expand</a>(ColXpr c) {
<a name="l00357"></a>00357   <span class="keywordtype">int</span>   i,j,k;
<a name="l00358"></a>00358   <span class="keywordtype">int</span>   extracols;
<a name="l00359"></a>00359   <span class="keywordtype">bool</span>  fullyExpand[M];
<a name="l00360"></a>00360   <span class="keywordtype">bool</span>  pixelExpand[M];
<a name="l00361"></a>00361 
<a name="l00362"></a>00362   <span class="comment">// --- First calculate how many cols to insert</span>
<a name="l00363"></a>00363   extracols = 1;
<a name="l00364"></a>00364   <span class="keywordflow">for</span>(i = 0; i&lt;M; ++i) {
<a name="l00365"></a>00365     <span class="keywordflow">if</span>(c(3*i+2) == 0.0 &amp;&amp; !<a class="code" href="classMeasurementMatrix.html#1fd2d5bcf0da4f91f14f05fea1394072">is_fully_expanded</a>(i)) {
<a name="l00366"></a>00366       <span class="keywordflow">if</span>(std::signbit(c(3*i+2)) == 0) {
<a name="l00367"></a>00367         <span class="comment">// --- full expansion</span>
<a name="l00368"></a>00368         fullyExpand[i] = <span class="keyword">true</span>;
<a name="l00369"></a>00369         pixelExpand[i] = <span class="keyword">false</span>;
<a name="l00370"></a>00370         extracols += 3;
<a name="l00371"></a>00371       } <span class="keywordflow">else</span> {
<a name="l00372"></a>00372         <span class="comment">// --- Pixel expansion</span>
<a name="l00373"></a>00373         fullyExpand[i] = <span class="keyword">false</span>;
<a name="l00374"></a>00374         pixelExpand[i] = <span class="keyword">true</span>;
<a name="l00375"></a>00375         ++extracols;
<a name="l00376"></a>00376       }
<a name="l00377"></a>00377     } <span class="keywordflow">else</span> {
<a name="l00378"></a>00378       <span class="comment">// --- no expansion</span>
<a name="l00379"></a>00379       fullyExpand[i] = <span class="keyword">false</span>;
<a name="l00380"></a>00380       pixelExpand[i] = <span class="keyword">false</span>;
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382   }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   <span class="comment">// --- now insert cols and fill</span>
<a name="l00385"></a>00385   k = j = <a class="code" href="classMeasurementMatrix.html#05d194eb20237c7c874213c74819754b">new_columns</a>(extracols);
<a name="l00386"></a>00386   col(j) = c;
<a name="l00387"></a>00387   ++j;
<a name="l00388"></a>00388   <span class="keywordflow">for</span>(i = 0; i&lt;M; ++i) {
<a name="l00389"></a>00389     <span class="keywordflow">if</span>(fullyExpand[i]) {
<a name="l00390"></a>00390       middleCols(j,3).fill(0.0);
<a name="l00391"></a>00391       (*this)(3*i   , j  ) = 1.0;
<a name="l00392"></a>00392       (*this)(3*i+1 , j+1) = 1.0;
<a name="l00393"></a>00393       (*this)(3*i+2 , j+2) = 1.0;
<a name="l00394"></a>00394       j += 3;
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pixelExpand[i]) {
<a name="l00397"></a>00397       col(j).fill(0.0);
<a name="l00398"></a>00398       col(j)(3*i+2) = 1.0;
<a name="l00399"></a>00399       col(j).middleRows(3*i,2) = c.middleRows(3*i,2);
<a name="l00400"></a>00400       col(k).middleRows(3*i,3).fill(0.0);
<a name="l00401"></a>00401       ++j;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403   }
<a name="l00404"></a>00404   <span class="keywordflow">return</span>(k);
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00413"></a>00413 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00414"></a><a class="code" href="classMeasurementMatrix.html#ca516a2d496e1a22cdaa78a88b13c594">00414</a> <span class="keywordtype">int</span> <a class="code" href="classMeasurementMatrix.html#ca516a2d496e1a22cdaa78a88b13c594">MeasurementMatrix&lt;M&gt;::insert_columns</a>(ColsBlockXpr c) {
<a name="l00415"></a>00415   <span class="keywordtype">int</span> initialCols = cols();
<a name="l00416"></a>00416 
<a name="l00417"></a>00417   conservativeResize(Eigen::NoChange, initialCols + c.cols());  
<a name="l00418"></a>00418   middleCols(initialCols, c.cols()) = c;
<a name="l00419"></a>00419   <span class="keywordflow">return</span>(initialCols);
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 
<a name="l00426"></a>00426 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00427"></a><a class="code" href="classMeasurementMatrix.html#c9e4c50f0453460de208067444dcf4cb">00427</a> <span class="keywordtype">void</span> <a class="code" href="classMeasurementMatrix.html#c9e4c50f0453460de208067444dcf4cb">MeasurementMatrix&lt;M&gt;::delete_column</a>(<span class="keywordtype">int</span> i) {
<a name="l00428"></a>00428   <span class="keywordflow">while</span>(i &lt; cols()-1) {
<a name="l00429"></a>00429     col(i) = col(i+1);
<a name="l00430"></a>00430   }
<a name="l00431"></a>00431   conservativeResize(Eigen::NoChange, cols()-1);
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 
<a name="l00438"></a>00438 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00439"></a><a class="code" href="classMeasurementMatrix.html#0052401400707b803be18b5334f6d699">00439</a> <span class="keywordtype">void</span> <a class="code" href="classMeasurementMatrix.html#0052401400707b803be18b5334f6d699">MeasurementMatrix&lt;M&gt;::delete_columns</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> n) {
<a name="l00440"></a>00440   <span class="keywordflow">while</span>(i &lt; cols()-n) {
<a name="l00441"></a>00441     col(i) = col(i+n);
<a name="l00442"></a>00442   }
<a name="l00443"></a>00443   conservativeResize(Eigen::NoChange, cols()-n);
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 
<a name="l00452"></a>00452 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00453"></a><a class="code" href="classMeasurementMatrix.html#c66ccaf22bcef4e339ffe9d6c98a103b">00453</a> <span class="keywordtype">void</span> <a class="code" href="classMeasurementMatrix.html#c66ccaf22bcef4e339ffe9d6c98a103b">MeasurementMatrix&lt;M&gt;::insert_pixel</a>(<span class="keywordtype">int</span> col, <span class="keyword">const</span> <a class="code" href="classGPixel.html">GPixel</a> &amp;p) {
<a name="l00454"></a>00454   <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(p.<a class="code" href="classGPixel.html#5838e0e085f8bc6267d57e83732fa10e">id</a>, col)(0) = p.<a class="code" href="classGPixel.html#7bd069cdb4aa390e7de6fbdd35fd6181">x</a>;
<a name="l00455"></a>00455   <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(p.<a class="code" href="classGPixel.html#5838e0e085f8bc6267d57e83732fa10e">id</a>, col)(1) = p.<a class="code" href="classGPixel.html#fbcc5faf9aed7beb2427625d244b1cf6">y</a>;
<a name="l00456"></a>00456   <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(p.<a class="code" href="classGPixel.html#5838e0e085f8bc6267d57e83732fa10e">id</a>, col)(2) = 1.0;
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00464"></a>00464 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00465"></a><a class="code" href="classMeasurementMatrix.html#e6dc25c2b3aa8eeab7b19dfc36d87051">00465</a> <span class="keywordtype">void</span> <a class="code" href="classMeasurementMatrix.html#e6dc25c2b3aa8eeab7b19dfc36d87051">MeasurementMatrix&lt;M&gt;::merge_columns</a>(<span class="keywordtype">int</span> j1, <span class="keywordtype">int</span> j2) {
<a name="l00466"></a>00466   <span class="comment">// --- copy pixels from j2 to j1</span>
<a name="l00467"></a>00467   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i&lt;M; ++i) {
<a name="l00468"></a>00468     <span class="keywordflow">if</span>(<a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j1)(2) == 0.0 &amp;&amp; <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j2)(2) != 0.0) {
<a name="l00469"></a>00469       <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j1) = <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(i,j2);
<a name="l00470"></a>00470     }
<a name="l00471"></a>00471   }
<a name="l00472"></a>00472   <a class="code" href="classMeasurementMatrix.html#c9e4c50f0453460de208067444dcf4cb">delete_column</a>(j2);
<a name="l00473"></a>00473 }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 
<a name="l00481"></a>00481 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00482"></a><a class="code" href="classMeasurementMatrix.html#c7fe1b3d19b2186f10847a51d17d66ec">00482</a> <span class="keywordtype">int</span> <a class="code" href="classMeasurementMatrix.html#c7fe1b3d19b2186f10847a51d17d66ec">MeasurementMatrix&lt;M&gt;::rank</a>(<span class="keywordtype">double</span> threshold) {
<a name="l00483"></a>00483   <span class="keywordtype">int</span> i;
<a name="l00484"></a>00484   Eigen::JacobiSVD&lt;Base&gt; svd(*<span class="keyword">this</span>);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486   <span class="keywordflow">if</span>(svd.singularValues().size() == 0) <span class="keywordflow">return</span>(0);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   threshold *= fabs(svd.singularValues()(0));
<a name="l00489"></a>00489   i = 1;
<a name="l00490"></a>00490   <span class="keywordflow">while</span>(i &lt; svd.singularValues().size() &amp;&amp; 
<a name="l00491"></a>00491         fabs(svd.singularValues()(i)) &gt; threshold)
<a name="l00492"></a>00492     ++i;
<a name="l00493"></a>00493   <span class="keywordflow">return</span>(i);
<a name="l00494"></a>00494 }
<a name="l00495"></a>00495 
<a name="l00496"></a>00496 
<a name="l00503"></a>00503 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00504"></a><a class="code" href="classMeasurementMatrix.html#1fd2d5bcf0da4f91f14f05fea1394072">00504</a> <span class="keywordtype">bool</span> <a class="code" href="classMeasurementMatrix.html#1fd2d5bcf0da4f91f14f05fea1394072">MeasurementMatrix&lt;M&gt;::is_fully_expanded</a>(<span class="keywordtype">int</span> view) {
<a name="l00505"></a>00505   <span class="keywordtype">int</span> j;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507   <span class="keywordflow">for</span>(j = 0; j&lt;cols(); ++j) {
<a name="l00508"></a>00508     <span class="keywordflow">if</span>(<a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(view, j)(2) == 0.0 &amp;&amp; <a class="code" href="classMeasurementMatrix.html#976bed12b8bacb9648d8e0e3265c2968">pixel</a>(view, j)(0) == 1.0) <span class="keywordflow">return</span>(<span class="keyword">true</span>);
<a name="l00509"></a>00509   }
<a name="l00510"></a>00510   <span class="keywordflow">return</span>(<span class="keyword">false</span>);
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 
<a name="l00516"></a>00516 <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> M&gt;
<a name="l00517"></a>00517 <span class="keyword">template</span>&lt;<span class="keyword">class</span> D&gt;
<a name="l00518"></a>00518 <a class="code" href="classMeasurementMatrix.html">MeasurementMatrix&lt;M&gt;</a> &amp;<a class="code" href="classMeasurementMatrix.html">MeasurementMatrix&lt;M&gt;::operator=</a>(<span class="keyword">const</span> Eigen::MatrixBase&lt;D&gt; &amp;o) {
<a name="l00519"></a>00519   Base::operator =(o);
<a name="l00520"></a>00520   <span class="keywordflow">return</span>(*<span class="keyword">this</span>);
<a name="l00521"></a>00521 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Thu Jun 21 14:29:42 2012 for ProCamSolver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
